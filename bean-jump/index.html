<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bean Jump - High Score Edition</title>
    <meta name="monetag" content="e843e7f5a6594ee646896681634a4208" />
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
    </style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/kaplay@3001.0.0-alpha.20/dist/kaplay.js"></script>

<script>
    kaplay({
        background: [135, 206, 235],
        touchToMouse: true, 
    });

    setGravity(2400);
    loadBean(); 

    // SAVE SYSTEM
    function saveHighScore(score) {
        const currentHigh = getData("highScore", 0);
        if (score > currentHigh) {
            setData("highScore", score);
            return true; 
        }
        return false;
    }

    scene("game", () => {
        
        let currentSpeed = 480; 
        let score = 0;
        let highScore = getData("highScore", 0);

        const bean = add([
            sprite("bean"),
            pos(80, 40),
            area(),
            body(), 
        ]);

        add([
            rect(width(), 48),
            pos(0, height() - 48),
            outline(4),
            area(),
            body({ isStatic: true }),
            color(127, 200, 100),
        ]);

        // Score Labels
        const scoreLabel = add([
            text("Score: 0"),
            pos(24, 24),
        ]);
        
        add([
            text("Best: " + highScore),
            pos(24, 60),
            scale(0.6), 
            color(0, 0, 0),
        ]);

        function jump() {
            if (bean.isGrounded()) {
                bean.jump(1000);
            }
        }

        onKeyPress("space", jump);
        onMousePress(jump); 

        function spawnTree() {
            add([
                rect(48, rand(24, 64)),
                area(),
                outline(4),
                pos(width(), height() - 48),
                anchor("botleft"),
                color(255, 180, 255),
                move(LEFT, currentSpeed), 
                "tree", 
            ]);

            let waitTime = map(currentSpeed, 480, 1000, 1.5, 0.7);
            wait(rand(waitTime - 0.2, waitTime + 0.2), spawnTree);
        }

        spawnTree();

        // --- 45 SECOND SPEED BOOST ---
        loop(45, () => {
            currentSpeed += 150; 
            shake(10); 
            
            // FIXED: Added "opacity(1)" so lifespan doesn't crash
            add([
                text("SPEED UP!", { size: 64 }),
                pos(center()),
                anchor("center"),
                color(255, 0, 0),
                opacity(1), // <--- THIS WAS MISSING
                lifespan(2, { fade: 0.5 }), 
            ]);
        });

        bean.onCollide("tree", () => {
            addKaboom(bean.pos);
            shake();
            go("lose", score);
        });

        onUpdate(() => {
            score++;
            scoreLabel.text = "Score: " + score;
        });
    });

    scene("lose", (score) => {
        const isNewRecord = saveHighScore(score);
        const bestScore = getData("highScore", 0);

        add([
            text("GAME OVER"),
            pos(center().x, center().y - 100),
            anchor("center"),
            color(0, 0, 0),
        ]);

        add([
            text("Score: " + score),
            pos(center().x, center().y),
            anchor("center"),
            scale(1.5),
            color(0, 0, 255),
        ]);

        add([
            text(isNewRecord ? "NEW HIGH SCORE!" : "High Score: " + bestScore),
            pos(center().x, center().y + 80),
            anchor("center"),
            color(isNewRecord ? rgb(255, 0, 0) : rgb(100, 100, 100)), 
        ]);

        add([
            text("Press SPACE to Restart"),
            pos(center().x, height() - 100),
            anchor("center"),
            scale(0.8),
            opacity(0.8) 
        ]);

        onKeyPress("space", () => go("game"));
        onMousePress(() => go("game"));
    });

    go("game");
</script>
</body>
</html>
