<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bean Jump</title>
    <meta name="monetag" content="e843e7f5a6594ee646896681634a4208" />
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
    </style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/kaplay@3001.0.0-alpha.20/dist/kaplay.js"></script>

<script>
    // 1. Initialize
    kaplay({
        background: [135, 206, 235], // Sky Blue
    });

    // --- THE FIX IS HERE ---
    setGravity(2400); // Turns on gravity! (Higher number = faster fall)
    // -----------------------

    // 2. Load Assets
    loadBean(); 

    // 3. Define Game Scene
    scene("game", () => {
        
        // Add Player
        const bean = add([
            sprite("bean"),
            pos(80, 40),
            area(),
            body(), // Now this will actually react to gravity!
        ]);

        // Add Ground
        add([
            rect(width(), 48),
            pos(0, height() - 48),
            outline(4),
            area(),
            body({ isStatic: true }),
            color(127, 200, 100),
        ]);

        // Instructions
        add([
            text("Press SPACE to Jump", { size: 24 }),
            pos(center().x, center().y - 100),
            anchor("center"),
            color(0, 0, 0),
            opacity(0.5)
        ]);

        // Jump Action
        function jump() {
            // Only jump if we are touching the ground
            if (bean.isGrounded()) {
                bean.jump(1000); // Power of the jump
            }
        }

        onKeyPress("space", jump);
        onTouchStart(jump);

        // Spawn Obstacles
        loop(1.5, () => {
            add([
                rect(48, rand(24, 64)),
                area(),
                outline(4),
                pos(width(), height() - 48),
                anchor("botleft"),
                color(255, 180, 255),
                move(LEFT, 480),
                "tree", // Tag
            ]);
        });

        // Collision Logic
        bean.onCollide("tree", () => {
            addKaboom(bean.pos);
            shake();
            go("lose", score);
        });

        // Score
        let score = 0;
        const scoreLabel = add([
            text(score),
            pos(24, 24),
        ]);

        onUpdate(() => {
            score++;
            scoreLabel.text = score;
        });
    });

    // Game Over Scene
    scene("lose", (score) => {
        add([
            text("Game Over"),
            pos(center()),
            anchor("center"),
        ]);
        add([
            text(score),
            pos(center().x, center().y + 80),
            anchor("center"),
            scale(2),
        ]);
        onKeyPress("space", () => go("game"));
        onTouchStart(() => go("game"));
    });

    go("game");
</script>
</body>
</html>
